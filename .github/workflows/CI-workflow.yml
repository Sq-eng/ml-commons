name: Build and Test ml-commons
# This workflow is triggered on pull requests and push to any branches
on:
  push:
    branches-ignore:
      - 'backport/**'
      - 'create-pull-request/**'
      - 'dependabot/**'
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  id-token: write
  contents: read

jobs:
  Get-CI-Image-Tag:
    uses: opensearch-project/opensearch-build/.github/workflows/get-ci-image-tag.yml@main
    with:
      product: opensearch

  Build-ml-linux:
    needs: Get-CI-Image-Tag
    strategy:
      matrix:
        java: [11]
        #java: [11, 17, 20]

    name: Build and Test MLCommons Plugin
    if: github.repository == 'opensearch-project/ml-commons'
    environment: ml-commons-cicd-env
    runs-on: ubuntu-latest
    container:
      # using the same image which is used by opensearch-build team to build the OpenSearch Distribution
      # this image tag is subject to change as more dependencies and updates will arrive over time
      image: ${{ needs.Get-CI-Image-Tag.outputs.ci-image-version-linux }}
      # need to switch to root so that github actions can install runner binary on container without permission issues.
      options: --user root

    steps:
      - name: Setup Java ${{ matrix.java }}
        uses: actions/setup-java@v1
        with:
          java-version: ${{ matrix.java }}

      - uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.ML_ROLE }}
          aws-region: us-west-2

      - name: Checkout MLCommons
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Build and Run Tests
        run: |
          chown -R 1000:1000 `pwd`
          su `id -un 1000` -c 'whoami && java -version && 
                               export OPENAI_KEY=`aws secretsmanager get-secret-value --secret-id github_openai_key --query SecretString --output text` &&
                               export COHERE_KEY=`aws secretsmanager get-secret-value --secret-id github_cohere_key --query SecretString --output text` &&
                               echo "::add-mask::$OPENAI_KEY" &&
                               echo "::add-mask::$COHERE_KEY" &&
                               ./gradlew build &&
                               ./gradlew publishToMavenLoca &&
                               ./gradlew integTest -PnumNodes=3'
      - name: Upload Coverage Report
        uses: codecov/codecov-action@v1
        with:
          flags: ml-commons
          token: ${{ secrets.CODECOV_TOKEN }}

##  Build-ml-windows:
##    strategy:
##      matrix:
##        java: [11, 17, 20]
##    name: Build and Test MLCommons Plugin on Windows
##    if: github.repository == 'opensearch-project/ml-commons'
##    environment: ml-commons-cicd-env
##    runs-on: windows-latest
##
##    steps:
##      - name: Setup Java ${{ matrix.java }}
##        uses: actions/setup-java@v1
##        with:
##          java-version: ${{ matrix.java }}
##
##      - uses: aws-actions/configure-aws-credentials@v2
##        with:
##          role-to-assume: ${{ secrets.ML_ROLE }}
##          aws-region: us-west-2
##
##      # ml-commons
##      - name: Checkout MLCommons
##        uses: actions/checkout@v3
##        with:
##          ref: ${{ github.event.pull_request.head.sha }}
##
##      - name: Build and Run Tests
##        shell: bash
##        run: |
##          export OPENAI_KEY=$(aws secretsmanager get-secret-value --secret-id github_openai_key --query SecretString --output text)
##          export COHERE_KEY=$(aws secretsmanager get-secret-value --secret-id github_cohere_key --query SecretString --output text)
##          echo "::add-mask::$OPENAI_KEY"
##          echo "::add-mask::$COHERE_KEY"
##          ./gradlew.bat build
##      - name: Publish to Maven Local
##        run: |
##          ./gradlew publishToMavenLocal
#      - name: Multi Nodes Integration Testing
#        shell: bash
#        run: |
#          export OPENAI_KEY=$(aws secretsmanager get-secret-value --secret-id github_openai_key --query SecretString --output text)
#          export COHERE_KEY=$(aws secretsmanager get-secret-value --secret-id github_cohere_key --query SecretString --output text)
#          echo "::add-mask::$OPENAI_KEY"
#          echo "::add-mask::$COHERE_KEY"
#          ./gradlew integTest -PnumNodes=3
